# VGC AI Battle System - 現状サマリ

**最終更新**: 2025-12-29 18:22 JST

---

## 🎯 プロジェクト概要

**VGC AI Battle System** は、ポケモンVGC（Video Game Championships）のダブルバトルに対応したAIプレイヤーシステムです。

### 主な機能
1. **VGC AIプレイヤー** - 人間のチャレンジを受けて自動対戦
2. **勝率予測** - ターン毎にAI/相手両方の勝率を表示
3. **行動予測** - 各ポケモンの予測行動と確率をダブルバトル形式で表示
4. **Open Team Sheet対応** - Bo3フォーマットで相手の技が見える

---

## 📁 ディレクトリ構造

```
new_watch_game_system/
│
├── 🎮 frontend/                    # プレゼンテーション層
│   ├── vgc_ai_player.py           # ★ メインAIプレイヤー
│   └── spectator.py               # 観戦システム
│
├── 🧠 predictor/                   # コア予測エンジン（安定版）
│   ├── player/                    # ストラテジスト実装
│   │   ├── hybrid_strategist.py   # Fast-Lane + MCTS統合
│   │   ├── fast_strategist.py     # LightGBM即時推論
│   │   └── monte_carlo_strategist.py # Pure MCTS
│   ├── core/                      # モデル・評価関数
│   │   ├── models.py              # BattleState, ActionCandidate等
│   │   └── eval_algorithms/       # 評価アルゴリズム
│   └── engine/                    # 外部連携
│       └── smogon_calc_wrapper.py # ダメージ計算
│
├── 🚀 scripts/                     # エントリーポイント
│   ├── run_vgc_ai.py              # ★ AI起動スクリプト
│   └── run_battle_spectator.py    # 観戦起動スクリプト
│
├── 📊 models/                      # 学習済みモデル
│   └── fast_lane.pkl              # LightGBMモデル
│
├── 🏗️ src/                         # DDDテンプレート（移行中）
│   ├── domain/                    # ドメイン層
│   ├── application/               # アプリケーション層
│   ├── infrastructure/            # インフラ層
│   └── ui/                        # UI層
│
├── 📚 docs/                        # ドキュメント
│   ├── TECH_STACK.md              # 技術スタック
│   └── PROGRESS.md                # 進捗管理
│
├── 🎲 pokemon-showdown/            # Showdownサーバー（サブモジュール）
│
└── 🐍 .venv/                       # Python仮想環境
```

---

## 🔄 ファイル間の依存関係

```text
+-------------------------------------------------------+
|             Infrastructure / Showdown                 |
|                                                       |
|  [ Showdown Server ] <====> [ poke-env Client ]       |
|          ^                         |                  |
|          |                         v                  |
+----------|-------------------------|------------------+
           |                         |
           | Websocket               | Battle Message
           |                         v
+----------|--------------------------------------------+
|          |    Application Layer (Frontend)            |
|          |                                            |
|          |     +-------------------------+            |
|          +-----|      VGCAIPlayer        |<-----+     |
|                +-------------------------+      |     |
|                             |                   |     |
|                             | (Future)          |     |
|   +-------------------+     v           +-------------+
|   | Spectator System  | ---->           |     OCR     |
|   | (Switch Capture)  |                 +-------------+
|   +-------------------+                      ^        |
+----------------------------------------------|--------+
                                               |
+----------------------------------------------|--------+
|               Domain Layer                   |        |
|                                              |        |
|  +------------------+    +----------------+  |        |
|  | ActionFilterSvc  |    | TurnOrderSvc   |  |        |
|  +------------------+    +----------------+  |        |
|           |                      |           |        |
|           v                      v           |        |
|  +------------------+    +----------------+  |        |
|  | Item/Move Models |<---| ShowdownLoader |  |        |
|  +------------------+    +----------------+  |        |
+----------------------------------------------|--------+
        ^            ^                         |
        |            |                         |
        |            |                         v
+-------|------------|----------------------------------+
|       |            |   Prediction Engine              |
|       |            |                                  |
|   +---|------------|--------+      +---------------+  |
|   | MonteCarloStrategist    |<-----| HybridStrategy|  |
|   +-------------------------+      +---------------+  |
|                                            |          |
|                                            v          |
|                                    +---------------+  |
|                                    | FastStrategist|  |
|                                    | (LightGBM)    |  |
|                                    +---------------+  |
+-------------------------------------------------------+
```

---

## ⚠️ 未解決の課題 / TODO

1.  ~~**MCTSの精度向上**~~ ✅ **完了** (2025-12-29)
    -   Guided Playouts 実装（ヒューリスティックに基づく重み付け選択）
    -   Consistent Action Generation（パニック交代防止）

2.  **勝率予測の精度**
    -   Fast-Lane (LightGBM) の特徴量が13個と少ない
    -   より多くの特徴量でモデルを再学習する必要あり

3.  **選出ロジック**
    -   現在は先頭4匹固定 (`/team 1234`)
    -   相手チームを見て選出を最適化する必要あり

4.  **AlphaZero統合**
    -   Policy/Value モデルの学習が未完了

5.  **フェーズベースのバトル状態管理機構** (2025-12-29追加)
    -   現在の状況（チームプレビュー / 通常行動選択 / 強制交代等）を明確に把握
    -   ターンとフェーズごとに適切な処理を分岐するステートマシンを実装
    -   `choose_move()`内の分岐を整理し、各フェーズごとに専用のハンドラを用意
    -   **進捗**: 強制交代 (`force_switch`) の判定ロジックバグを修正済み (2025-12-29)

6.  **poke-env Bo3サポートの問題**
    -   `game-bestof3-*`メッセージの解析でIndexErrorが発生
    -   poke-envがBo3フォーマットを完全にサポートしていない可能性

✅ **完了済みのタスク**

*   ~~**行動順序予測**~~ (2025-12-29)
    -   `TurnOrderService` 実装済み。素早さ、麻痺、スカーフ、追い風などを考慮して攻撃順を表示。
*   ~~**ターゲット表示改善**~~ (2025-12-29)
    -   単体技のターゲット（例: `→ Urshifu`）を予測表示に追加。
*   ~~**強制交代のバグ修正**~~ (2025-12-29)
    -   `pass` を誤送信するバグを修正。`any(force_switch)` で正しく判定。
*   ~~**持ち物、特性を踏まえた行動**~~ (2025-12-29)
    -   `ShowdownDataLoader` 導入、火力補正などを計算ロジックに反映。
*   ~~**Guided Playouts (Phase 3)**~~ (2025-12-29)
    -   MCTSシミュレーションでヒューリスティックに基づく重み付け選択を実装。
*   ~~**KnowledgeService + Consistent Action (Phase 4)**~~ (2025-12-29)
    -   PokeLLMon 研究に基づく KAG（外部知識活用）とパニック交代防止を実装。

---

## 🚀 アーキテクチャ再設計 (2025-12-30)

外部エンジニアフィードバックに基づく根本的な予測ロジック改善。

**前提**: SVダブル・Showdown・オープンチームシート（完全情報）

### ✅ Phase A: 予測ロジック実装（完了）

| 実装 | 状態 | ファイル |
|------|------|----------|
| `PredictResult` データクラス | ✅ | `predictor/core/prediction_engine.py` |
| 候補手生成（Top-K） | ✅ | `ActionGenerator` |
| Quantal Response 混合戦略 | ✅ | `solve_quantal_game()` |
| 利得行列 U(a,b) 推定 | ✅ | ヒューリスティック |
| VGCAIPlayer 統合 | ✅ | 行動分布表示対応 |

### ✅ Phase B: Policy/Value 学習基盤（完了）

| 実装 | 状態 | ファイル |
|------|------|----------|
| `StateFeatures`（40次元） | ✅ | `predictor/core/policy_value_learning.py` |
| `PolicyModel` / `ValueModel` | ✅ | LightGBM ベース |
| `MetamonTrainer` | ✅ | ログ→学習の統合 |
| PredictionEngine 統合 | ✅ | 学習Valueあれば自動使用 |
| Self-Play スクリプト | ✅ | `scripts/self_play_data_collection.py` |

### 🔲 Phase C: AlphaZero型PUCT探索（未着手）

- [ ] PUCT 選択式実装
- [ ] Value/Policy ネットワーク統合
- [ ] Self-play 強化ループ

### 🔲 Phase D: LLM活用（未着手）

- [ ] 候補生成補助
- [ ] KAG で根拠付き説明

---

## 📅 完成計画ロードマップ

```
┌─────────────────────────────────────────────────────────────────┐
│ Week 1: データ収集 & 学習                                        │
├─────────────────────────────────────────────────────────────────┤
│ - Self-Play で 500+ 試合分のデータ収集                           │
│ - PolicyModel / ValueModel 学習                                 │
│ - 予測精度評価（Top-1/Top-3 精度、ECE）                          │
└─────────────────────────────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────────────────────┐
│ Week 2: 探索強化 (Phase C)                                       │
├─────────────────────────────────────────────────────────────────┤
│ - PUCT実装（AlphaZero式探索）                                    │
│ - 学習済み Policy で候補生成                                     │
│ - 学習済み Value で葉評価                                        │
│ - Self-play → 再学習ループ                                       │
└─────────────────────────────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────────────────────┐
│ Week 3: 観戦UI & LLM (Phase D)                                   │
├─────────────────────────────────────────────────────────────────┤
│ - 行動分布・勝率・根拠をオーバーレイ表示                         │
│ - KAG で根拠付き説明文生成                                       │
│ - 配信者向け介入UI                                               │
└─────────────────────────────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────────────────────┐
│ Week 4: Switch実機観戦（将来）                                   │
├─────────────────────────────────────────────────────────────────┤
│ - ScreenReader イベント抽出                                      │
│ - ObservationState + confidence                                 │
│ - BeliefState（粒子フィルタ）                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 優先度順タスク

| 優先度 | タスク | 所要時間 |
|--------|--------|----------|
| 🔴 高 | Self-Play 500試合実行 | 数時間 |
| 🔴 高 | Policy/Value 学習 | 1日 |
| 🟡 中 | PUCT 探索実装 | 2-3日 |
| 🟡 中 | 予測精度評価スクリプト | 1日 |
| 🟢 低 | LLM 根拠説明 | 2日 |
| 🟢 低 | Switch観戦対応 | 1週間+ |

---

## 📚 参考研究

| 研究 | 適用箇所 | URL |
|------|----------|-----|
| Metamon | Policy/Value学習 | [arXiv:2504.04395](https://arxiv.org/abs/2504.04395) |
| PokéChamp | minimax + LLM | [arXiv:2503.04094](https://arxiv.org/abs/2503.04094) |
| PokeLLMon | KAG, パニック抑制 | [arXiv:2402.01118](https://arxiv.org/abs/2402.01118) |
| PokéAgent | 評価設計 | [pokeagent.github.io](https://pokeagent.github.io/) |

---

**最終更新**: 2025-12-30 00:30
**ファイル作成者**: Antigravity (AI Assistant)

