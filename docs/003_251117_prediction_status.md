# 2025/11/17 時点の予測パイプラインまとめ（初心者向け）

## ざっくり全体像

1. **入力**  
   - Pokepaste（自分/相手のパーティ情報）  
   - Battle Log（過去のターン記録）  
   - 推定 EV（任意で上書き可）  

2. **処理パイプライン**  
   1. **TeamParser** が Pokepaste を Showdown 形式に揃える  
   2. **EVEstimator** が priors（`data/ev_priors.json`）とログを使って EV 仮説を更新  
   3. **StateRebuilder + ObservationBuilder** が BattleState を再構築し、技のタグ・命中率・ダメージ見込みを付与  
   4. **Evaluation Algorithm**（今はヒューリスティックのみ）が勝率と推奨技を計算  

3. **出力**  
   - `playerA` / `playerB` ごとの勝率、各ポケモンのおすすめ技ランキング  
   - フロントエンドではゲージ・技カード・盤面再現・ターン履歴として表示  

## プレイヤーの思考フローと対応状況

| 思考フェーズ | 今できていること | 足りていないこと |
| --- | --- | --- |
| **初見情報整理**（相手パーティの型、EV 傾向） | Pokepaste → TeamParser、EVEstimator で基本的な型推定 | priors が薄い（環境トップ以外は 252/252 に寄りがち）、不確実さの可視化が無い |
| **盤面把握**（HP・状態・残ターン） | StateRebuilder で HP/状態/フィールドを復元、UI で中央の「バトルフィールド」を表示 | Trick Room・天候の残りターン、味方/相手のリザーブ情報を細かく出せていない |
| **技候補の比較** | `annotate_actions` タグとダメージ推定を使い、技カードにタイプ・威力・追加効果を表示 | モーメンタム変化（集中攻撃で倒せるか等）を点数化しきれていない |
| **ターン振り返り** | Battle Log からターン別ページを生成し、誰がどの技で何%削ったかを漫画風に表示 | Showdown ログと完全一致させるには、各種特性/持ち物の影響をもっと細かく反映する必要がある |
| **勝率の解釈** | 勝率ゲージ＋テキストで「なぜこの勝率か」を簡単に説明（リード/ビハインド、最優先技） | リスク度・波乱度（当たれば勝ち、外せば負け）を数値化していない |

## 現在の UI/UX の状態

- 中央に「バトルフィールド」カード、左右に自分/相手の Pokepaste 入力欄を置き、入力後すぐ盤面プレビューが見える構成に変更済み。  
- Battle Log をマンガのコマのようにページ送りでき、技のタイプ色・威力・追加効果・ターゲット・ダメージ量を Showdown データからそのまま表示。  
- 技カードやおすすめ技リストでもタイプ色・威力・分類を明示し、日本語名と英語名を並記。  

## 技・ダメージ精度に関する現状

- 技データは Showdown 由来 (`data/showdown/moves.json`) をそのまま利用している。  
- 付与できる状態異常 (`statusEffects`) を参照して、Battle Log の表示にあり得ない状態が出ないように調整済み。  
- ただし、実際のダメージ計算はヒューリスティックな推定であり、乱数幅・特性・場の補正を完全再現できていない。  
- Flare Blitz のような反動技は「反動」「状態異常」の区別を今後さらに厳密化する必要あり。  

## 足りていない/今後やるべきこと

1. **Showdown との完全同期**  
   - 技の挙動（範囲、優先度、追加効果）、持ち物、特性、ダメージ補正などをもっと細かく取り込む。  
   - priors を実戦データから埋め、EV 推定の不確実性をスコアにも反映させる。  

2. **アルゴリズム拡張**  
   - MCTS の簡易版や浅いロールアウトを用意し、ヒューリスティック結果と比較できるようにする。  
   - 評価結果に「使用アルゴリズム名」「処理時間」「探索深さ」などのメタ情報を付与。  

3. **プレイヤー目線の説明強化**  
   - 勝率変化、リスク度、ハイライト度（このターンが山場かどうか）を算出して説明カードに表示。  
   - 「集中攻撃でこのポケモンが落ちる」など、人が考えるラインを推定してコメントできるようにする。  

4. **検証・運用面**  
   - 代表的な盤面のスナップショットテストを `tests/` に追加。  
   - `--debug` モードで中間状態（EV 推定結果やタグ付け情報）を dump できるようにする。  
   - パフォーマンス目標（1 盤面あたり何 ms 以内）とタイムアウト戦略を明文化。  

## まとめ

- **できていること**: 入力〜勝率表示までのパイプラインが一通り動き、UI も「誰が何をやったか」を即座に確認できる状態。Showdown の技データと日本語名マップで表示の正確さを底上げ。  
- **不足していること**: Showdown との完全一致、MCTS/ML など別アルゴリズム、EV priors の充実、リスク/ハイライト指標など、実戦レベルで解説できる層はまだ未整備。  
- **次の一歩**: priors 充実＋簡易 MCTS の導入、ハイライト指標の実装、テスト整備あたりから着手するのが現実的。  
